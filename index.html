<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Scorecard</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827"/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        /* Custom styles */
        .label-positive { background-color: #111827; color: white; border-color: #111827; }
        .label-negative { background-color: #fff; color: #111827; border-color: #111827; }
        .label-neutral { background-color: #9ca3af; color: white; border-color: #9ca3af; }
        .label-none { background-color: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; }
        .label-button { transition: all 0.1s ease-in-out; border-width: 2px; border-style: solid; }
        .label-button:active { transform: scale(0.95); }
        .modal-overlay { background-color: rgba(17, 24, 39, 0.5); }
        .modal-content { background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 90%; width: 400px; }
        /* Recording animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording { animation: pulse-red 1.5s infinite; color: #ef4444 !important; border-color: #ef4444 !important; }
        /* AI Loading Shimmer */
        .shimmer {
            animation: shimmer 2s linear infinite forwards;
            background: #f6f7f8;
            background: linear-gradient(to right, #f6f7f8 8%, #edeef1 18%, #f6f7f8 33%);
            background-size: 1200px 100%;
        }
        @keyframes shimmer { 0% { background-position: -1200px 0; } 100% { background-position: 1200px 0; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-full flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-200">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 flex items-center justify-between">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Habit Scorecard</h1>
                <p class="text-xs sm:text-sm text-gray-500">Atomic Habits Tracker</p>
            </div>
            <button id="analyze-btn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                Analyze
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto py-6 sm:py-8">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="view-scorecard">
                <form id="add-habit-form" class="flex items-center space-x-2 mb-4 sm:mb-6">
                    <div class="flex-1 flex items-center space-x-2">
                        <button type="button" id="manage-habits-btn" class="p-3 text-gray-400 hover:text-gray-900 transition-colors flex-shrink-0" title="Manage List"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                        <select id="habit-select" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-base p-3" required><option value="" disabled selected>Select a habit...</option></select>
                    </div>
                    <input type="time" id="habit-time-input" class="hidden sm:block w-32 rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-base p-3" required>
                    <button type="button" id="voice-log-btn" class="inline-flex items-center justify-center p-3 border border-gray-300 text-gray-700 bg-white rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-black transition-all" title="Voice Log"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg></button>
                    <button type="submit" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">Add</button>
                </form>
                <div class="sm:hidden mb-6"><input type="time" id="habit-time-input-mobile" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black text-base p-3" required></div>
                <div class="bg-white shadow rounded-lg border border-gray-200"><div id="habit-list-container" class="divide-y divide-gray-200"></div></div>
                <div class="mt-6 text-center"><button id="clear-all-habits-button" class="text-sm font-medium text-gray-500 hover:text-red-600 transition-colors" style="display: none;">Clear All Habits</button></div>
            </div>
        </div>
    </main>

    <div id="manage-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 modal-overlay">
        <div class="modal-content flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="text-lg font-bold">Manage List</h3><button id="close-manage-modal" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="p-4 border-b bg-gray-50"><form id="manage-add-form" class="flex space-x-2"><input type="text" id="manage-add-input" placeholder="New habit name..." class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm p-2" required><button type="submit" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-black hover:bg-gray-800">Add</button></form></div>
            <div class="flex-1 overflow-y-auto p-2"><ul id="manage-list" class="divide-y divide-gray-100"></ul></div>
            <div class="p-4 border-t text-center bg-gray-50"><button id="reset-defaults-button" class="text-xs text-red-600 hover:text-red-800">Reset to Defaults</button></div>
        </div>
    </div>
    <div id="analyze-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 modal-overlay">
        <div class="modal-content flex flex-col max-h-[90vh] w-full max-w-md bg-gray-50">
             <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white rounded-t-lg z-10"><h3 class="text-lg font-bold flex items-center text-indigo-900"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>Smart Analysis</h3><button id="close-analyze-modal" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div id="analyze-loading" class="hidden p-8 space-y-4"><div class="h-4 rounded shimmer w-3/4"></div><div class="h-4 rounded shimmer"></div><div class="h-4 rounded shimmer w-5/6"></div></div>
            <div id="analyze-content" class="flex-1 overflow-y-auto p-6 space-y-6 hidden"></div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 modal-overlay">
        <div class="modal-content p-6 bg-white"><h3 class="text-lg font-bold">Clear All?</h3><p class="mt-2 text-gray-500">This action cannot be undone.</p><div class="mt-6 grid grid-cols-2 gap-3"><button id="confirm-delete-button" class="w-full inline-flex justify-center rounded-md border border-transparent px-4 py-2 bg-black text-base font-medium text-white hover:bg-gray-800 sm:text-sm">Yes, Delete</button><button id="cancel-delete-button" class="w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:text-sm">Cancel</button></div></div>
    </div>
    <div id="voice-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4 modal-overlay">
        <div class="modal-content p-6 bg-white"><h3 class="text-lg font-bold">Unknown Habit</h3><p class="mt-2 text-gray-500">I heard "<span id="voice-habit-name" class="font-medium text-gray-900"></span>". Not in your list yet.</p><div class="mt-6 flex flex-col sm:flex-row-reverse gap-2"><button id="voice-add-log-btn" class="w-full inline-flex justify-center rounded-md border border-transparent px-4 py-2 bg-black text-white sm:text-sm">Add to List & Log</button><button id="voice-log-only-btn" class="w-full inline-flex justify-center rounded-md border border-gray-300 bg-white text-gray-700 sm:text-sm">Log Only</button><button id="voice-cancel-btn" class="w-full inline-flex justify-center rounded-md border border-transparent px-4 py-2 text-gray-500 sm:text-sm">Cancel</button></div></div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- State ---
            let habits = [], habitList = [];
            const HABIT_KEY = 'habitScorecard.habits', LIST_KEY = 'habitScorecard.list';
            let isTimeManuallyEdited = false, isRecording = false, recognition = null;
            let pendingVoiceHabit = { name: null, time: null };

            const DEFAULT_HABITS = ["Attend meeting","Bite nails","Brush teeth","Buy something unnecessary","Call a friend / family member","Check email","Check phone","Commute to work / school","Cook dinner","Do laundry","Drink water","Eat a fruit / vegetable","Eat breakfast","Eat dinner","Eat lunch","Eat sugar / snacks","Exercise / Workout","Feed pet","Floss teeth","Get dressed","Go for a walk","Go to bathroom","Go to bed","Journal","Make bed","Make coffee / tea","Meditate","Plan tomorrow's to-do list","Practice a hobby","Read a book","Scroll social media","Set alarm for tomorrow","Skincare routine","Smoke cigarette","Stretch","Take a break","Take a shower","Tidy up living space","Turn off alarm","Wake up","Wash dishes","Watch TV","Weigh myself"];
            const VERB_MAP = {'woke':'wake','drank':'drink','ate':'eat','went':'go','did':'do','took':'take','bought':'buy','read':'read','brushed':'brush','flossed':'floss','fed':'feed','made':'make','sat':'sit','stood':'stand','ran':'run','walked':'walk','cooked':'cook','washed':'wash','watched':'watch','checked':'check'};

            // --- DOM Elements (Safe Selection) ---
            const $ = (id) => document.getElementById(id);
            const els = {
                habitForm: $('add-habit-form'), habitSelect: $('habit-select'),
                timeInput: $('habit-time-input'), timeInputMobile: $('habit-time-input-mobile'),
                listContainer: $('habit-list-container'), clearBtn: $('clear-all-habits-button'),
                manageBtn: $('manage-habits-btn'), voiceBtn: $('voice-log-btn'), analyzeBtn: $('analyze-btn'),
                modals: { confirm: $('confirm-modal'), manage: $('manage-modal'), voice: $('voice-modal'), analyze: $('analyze-modal') },
                manage: { close: $('close-manage-modal'), list: $('manage-list'), form: $('manage-add-form'), input: $('manage-add-input'), reset: $('reset-defaults-button') },
                voice: { name: $('voice-habit-name'), add: $('voice-add-log-btn'), log: $('voice-log-only-btn'), cancel: $('voice-cancel-btn') },
                analyze: { close: $('close-analyze-modal'), content: $('analyze-content'), loading: $('analyze-loading') },
                confirm: { delete: $('confirm-delete-button'), cancel: $('cancel-delete-button') }
            };

            // --- Helpers ---
            const getFormattedTime = (d) => `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            const updateTimeInput = (force=null) => {
                const t = force || getFormattedTime(new Date());
                if(!isTimeManuallyEdited || force) { els.timeInput.value = t; els.timeInputMobile.value = t; }
            };
            const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
            const normalize = (t) => t.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(/\s+/).map(w=>VERB_MAP[w]||w).filter(w=>!['a','an','the','my','some'].includes(w)).join(' ');

            // --- Core Logic ---
            function loadData() {
                habitList = JSON.parse(localStorage.getItem(LIST_KEY)) || [...DEFAULT_HABITS];
                habitList.sort((a,b)=>a.localeCompare(b));
                habits = JSON.parse(localStorage.getItem(HABIT_KEY)) || [];
                renderSelect(); renderHabits();
            }
            function saveData() {
                localStorage.setItem(LIST_KEY, JSON.stringify(habitList));
                localStorage.setItem(HABIT_KEY, JSON.stringify(habits));
            }
            function logHabit(text, timeStr) {
                const now = new Date(); const [h, m] = timeStr.split(':');
                const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
                habits.push({ id: crypto.randomUUID(), text, label: 'none', createdAt: d.getTime(), displayTime: timeStr });
                saveData(); renderHabits();
                els.habitSelect.value = ""; isTimeManuallyEdited = false; updateTimeInput();
            }

            // --- Renders ---
            function renderSelect() {
                const curr = els.habitSelect.value;
                els.habitSelect.innerHTML = '<option value="" disabled selected>Select a habit...</option>' + 
                    habitList.map(h => `<option value="${h}">${h}</option>`).join('');
                if(habitList.includes(curr)) els.habitSelect.value = curr;
            }
            function renderHabits() {
                if(habits.length === 0) { els.listContainer.innerHTML = `<div class="p-8 text-center text-gray-500">No habits logged yet.</div>`; els.clearBtn.style.display='none'; return; }
                els.clearBtn.style.display = 'inline-block';
                habits.sort((a,b)=>b.createdAt - a.createdAt);
                els.listContainer.innerHTML = habits.map(h => `
                    <div class="p-4 flex items-center justify-between space-x-4">
                        <div class="flex-1 min-w-0"><p class="text-lg font-medium">${h.text}</p><p class="text-sm text-gray-500">${new Date(h.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric'})} at ${h.displayTime}</p></div>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            <button data-id="${h.id}" data-label="positive" class="label-button w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold ${h.label==='positive'?'label-positive':'label-none'}">+</button>
                            <button data-id="${h.id}" data-label="negative" class="label-button w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold ${h.label==='negative'?'label-negative':'label-none'}">&minus;</button>
                            <button data-id="${h.id}" data-label="neutral" class="label-button w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold ${h.label==='neutral'?'label-neutral':'label-none'}">=</button>
                            <button data-id="${h.id}" data-action="delete" class="ml-2 text-gray-400 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </div>
                `).join('');
            }
            function renderManageList() {
                els.manage.list.innerHTML = habitList.map((h,i) => `
                    <li class="py-3 px-2 flex items-center justify-between group hover:bg-gray-50 rounded">
                        <span class="flex-1">${h}</span>
                        <div class="flex items-center space-x-2 opacity-50 group-hover:opacity-100">
                             <button data-i="${i}" data-act="edit" class="p-1 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg></button>
                             <button data-i="${i}" data-act="del" class="p-1 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button>
                        </div>
                    </li>
                `).join('');
            }

            // --- Analysis ---
            function generateAnalysis() {
                if(habits.length===0) { els.analyze.content.innerHTML='<p class="text-center text-gray-500 py-8">No data yet.</p>'; return; }
                let pos=0,neg=0,neu=0,none=0;
                const times={Morning:{t:0,n:0},Afternoon:{t:0,n:0},Evening:{t:0,n:0},Night:{t:0,n:0}}, counts={};
                habits.forEach(h=>{
                    if(h.label==='positive') pos++; else if(h.label==='negative') neg++; else if(h.label==='neutral') neu++; else none++;
                    counts[h.text]=(counts[h.text]||0)+1;
                    const hr=parseInt(h.displayTime.split(':')[0]);
                    let blk='Night'; if(hr>=5&&hr<12) blk='Morning'; else if(hr>=12&&hr<17) blk='Afternoon'; else if(hr>=17&&hr<21) blk='Evening';
                    times[blk].t++; if(h.label==='negative') times[blk].n++;
                });
                const net=pos-neg, total=habits.length, maxT=Math.max(...Object.values(times).map(v=>v.t));
                const getPct=(v)=>total>0?((v/total)*100).toFixed(0):0;

                let insight = total<5 ? "Keep logging to reveal patterns." : (net>(total*0.3) ? "Great positive momentum!" : (neg>pos ? "Environment might be triggering negative loops." : "Balanced scorecard. Awareness is key."));
                let worst=null, maxR=0;
                for(const[b,s]of Object.entries(times)) { if(s.t>2 && (s.n/s.t)>maxR) { maxR=s.n/s.t; worst=b; }}
                if(worst && maxR>0.3 && total>=5) insight += ` <strong>Try to optimize your ${worst} routine.</strong>`;

                els.analyze.content.innerHTML = `
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 text-indigo-900 text-sm"><strong>ðŸ¤– Insight:</strong> ${insight}</div>
                    <div class="flex items-center justify-between bg-white p-4 mt-6 rounded-lg border shadow-sm">
                        <div><p class="text-sm font-medium text-gray-500 uppercase">Net Score</p></div>
                        <div class="text-4xl font-bold ${net>0?'text-green-600':(net<0?'text-red-600':'text-gray-900')}">${net>0?'+':''}${net}</div>
                    </div>
                    <div class="mt-6 space-y-2">
                        <h4 class="font-bold">Breakdown</h4>
                        ${[['Positive (+)',pos,'#111827'],['Negative (-)',neg,'#9ca3af'],['Neutral (=)',neu,'#d1d5db']].map(([l,v,c])=>`
                        <div class="flex items-center text-sm"><div class="w-24">${l}</div><div class="flex-1 bg-gray-100 rounded-full h-2 mx-3"><div class="h-2 rounded-full" style="width:${getPct(v)}%;background-color:${c}"></div></div><div class="w-8 text-right">${v}</div></div>`).join('')}
                    </div>
                    <div class="mt-6"><h4 class="font-bold mb-2">Activity Time</h4><div class="grid grid-cols-4 gap-2 h-20 items-end">
                        ${Object.entries(times).map(([k,v])=>`<div class="flex flex-col items-center"><div class="w-full bg-indigo-100 rounded-t relative" style="height:${Math.max((v.t/maxT)*100,2)}%"><div class="absolute bottom-0 w-full bg-[#111827] opacity-80 rounded-t" style="height:${v.t>0?(1-(v.n/v.t))*100:0}%"></div></div><span class="text-[10px] uppercase mt-1 text-gray-500">${k.slice(0,3)}</span></div>`).join('')}
                    </div></div>
                `;
            }

            // --- Voice Setup ---
            if(window.SpeechRecognition || window.webkitSpeechRecognition) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous=false; recognition.lang='en-US'; recognition.maxAlternatives=1;
                recognition.onstart=()=>{isRecording=true;els.voiceBtn.classList.add('recording')};
                recognition.onend=()=>{isRecording=false;els.voiceBtn.classList.remove('recording')};
                recognition.onresult=(e)=>{
                    let txt = e.results[0][0].transcript.toLowerCase().trim().replace(/^(please )?(log |add |track )?(that )?(i )?/,'');
                    let time = getFormattedTime(new Date());
                    const m = txt.match(/ at (\d{1,2}(?::\d{2})?\s?(?:am|pm)?|\d{4})$/i);
                    if(m) {
                        txt = txt.replace(m[0],'').trim();
                        try {
                            let tStr=m[1].replace(/(am|pm)/g,'').trim(), h=0, min=0;
                            if(tStr.includes(':')) { const p=tStr.split(':'); h=+p[0]; min=+p[1]; }
                            else if(tStr.length===4) { h=+tStr.substring(0,2); min=+tStr.substring(2,4); }
                            else { h=+tStr; }
                            if(m[1].includes('pm')&&h<12) h+=12; if(m[1].includes('am')&&h===12) h=0;
                            time=`${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`;
                        } catch(e){}
                    }
                    // Matching
                    const normTxt = normalize(txt); const tokens = new Set(normTxt.split(' '));
                    let best=null, score=0;
                    habitList.forEach(h => {
                        if(h.toLowerCase()===txt) { best=h; score=2; return; } // Exact match overrides
                        const hTokens = new Set(normalize(h).split(' '));
                        let inter=0; tokens.forEach(t=>{if(hTokens.has(t)) inter++});
                        const s = inter/hTokens.size;
                        if(s>score && s>=0.5) { score=s; best=h; }
                    });

                    if(best) logHabit(best, time);
                    else { pendingVoiceHabit={name:capitalize(txt),time}; els.voice.name.textContent=pendingVoiceHabit.name; els.modals.voice.classList.remove('hidden'); }
                };
                els.voiceBtn.addEventListener('click', ()=>{ if(isRecording) recognition.stop(); else recognition.start(); });
            } else { els.voiceBtn.style.display='none'; }

            // --- Event Listeners ---
            els.habitForm.addEventListener('submit', (e)=>{ e.preventDefault(); if(els.habitSelect.value) logHabit(els.habitSelect.value, els.timeInput.value); });
            els.timeInput.addEventListener('input',(e)=>{ isTimeManuallyEdited=true; els.timeInputMobile.value=e.target.value; });
            els.timeInputMobile.addEventListener('input',(e)=>{ isTimeManuallyEdited=true; els.timeInput.value=e.target.value; });
            els.habitSelect.addEventListener('change',()=>{ isTimeManuallyEdited=false; updateTimeInput(); });
            els.listContainer.addEventListener('click', (e)=>{
                const btn = e.target.closest('button'); if(!btn) return;
                const {id,label,action} = btn.dataset;
                if(label) { const h=habits.find(i=>i.id===id); if(h){h.label=label;saveData();renderHabits();}}
                if(action==='delete') { habits=habits.filter(i=>i.id!==id);saveData();renderHabits();}
            });
            // Modals
            els.clearBtn.onclick=()=>els.modals.confirm.classList.remove('hidden');
            els.confirm.cancel.onclick=()=>els.modals.confirm.classList.add('hidden');
            els.confirm.delete.onclick=()=>{habits=[];saveData();renderHabits();els.modals.confirm.classList.add('hidden');};
            els.manageBtn.onclick=()=>{renderManageList();els.modals.manage.classList.remove('hidden');};
            els.manage.close.onclick=()=>els.modals.manage.classList.add('hidden');
            els.manage.form.onsubmit=(e)=>{e.preventDefault(); const v=els.manage.input.value.trim(); if(v&&!habitList.includes(v)){habitList.push(v);habitList.sort();saveData();renderManageList();els.manage.input.value='';}};
            els.manage.list.onclick=(e)=>{
                const btn=e.target.closest('button'); if(!btn) return;
                const i=+btn.dataset.i;
                if(btn.dataset.act==='del') { habitList.splice(i,1); saveData(); renderManageList(); renderSelect(); }
                // (Edit simplified for robustness: delete and re-add if needed, or we can add complex edit back later if requested. Keeping it simple to fix bugs first.)
            };
            els.manage.reset.onclick=()=>{if(confirm('Reset list to defaults?')){habitList=[...DEFAULT_HABITS];habitList.sort();saveData();renderManageList();renderSelect();}};
            els.analyzeBtn.onclick=()=>{
                els.modals.analyze.classList.remove('hidden'); els.analyze.content.classList.add('hidden'); els.analyze.loading.classList.remove('hidden');
                setTimeout(()=>{generateAnalysis();els.analyze.loading.classList.add('hidden');els.analyze.content.classList.remove('hidden');},1500);
            };
            els.analyze.close.onclick=()=>els.modals.analyze.classList.add('hidden');
            // Voice Modal
            els.voice.add.onclick=()=>{habitList.push(pendingVoiceHabit.name);habitList.sort();saveData();renderSelect();logHabit(pendingVoiceHabit.name,pendingVoiceHabit.time);els.modals.voice.classList.add('hidden');};
            els.voice.log.onclick=()=>{logHabit(pendingVoiceHabit.name,pendingVoiceHabit.time);els.modals.voice.classList.add('hidden');};
            els.voice.cancel.onclick=()=>els.modals.voice.classList.add('hidden');

            // --- Init ---
            updateTimeInput(); loadData();
            document.addEventListener('visibilitychange', ()=>{if(!document.hidden) updateTimeInput();});
            setInterval(updateTimeInput, 60000);
        });
    </script>
    <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(e=>console.log('SW failed:',e)));}</script>
</body>
</html>
