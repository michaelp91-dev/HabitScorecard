<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Scorecard</title>
    
    <!-- PWA Links -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10B981"/> <!-- Sets the browser top bar color -->
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Prevents pull-to-refresh on mobile */
            overscroll-behavior-y: contain;
        }
        /* Custom styles for habit labels */
        .label-positive {
            background-color: #10B981; /* Emerald 500 */
            color: white;
            border-color: #059669; /* Emerald 600 */
        }
        .label-negative {
            background-color: #EF4444; /* Red 500 */
            color: white;
            border-color: #DC2626; /* Red 600 */
        }
        .label-neutral {
            background-color: #6B7280; /* Gray 500 */
            color: white;
            border-color: #4B5563; /* Gray 600 */
        }
        .label-none {
            background-color: #F3F4F6; /* Gray 100 */
            color: #374151; /* Gray 700 */
            border-color: #D1D5DB; /* Gray 300 */
        }
        .label-button {
            transition: all 0.1s ease-in-out;
            border-width: 2px;
            border-style: solid;
        }
        .label-button:active {
            transform: scale(0.95);
        }
        
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            width: 400px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-full flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-2xl font-bold text-gray-900">My Habit Scorecard</h1>
            <p class="text-sm text-gray-500">Log your daily actions and label them: (+), (-), or (=).</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto py-8">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            
            <!-- Add Habit Form -->
            <form id="add-habit-form" class="flex items-center space-x-2 mb-6">
                <!-- Habit Text Input -->
                <input type="text" id="habit-input" placeholder="e.g., 'Woke up and checked phone'" class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-3" required>
                
                <!-- Time Input -->
                <input type="time" id="habit-time-input" class="block w-28 rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-3" required>
                
                <!-- Add Button -->
                <button type="submit" class="inline-flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                    Add
                </button>
            </form>

            <!-- Habit List -->
            <div class="bg-white shadow-sm rounded-lg">
                <div id="habit-list-container" class="divide-y divide-gray-200">
                    <!-- Habits will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Clear All Button -->
            <div class="mt-6 text-center">
                <button id="clear-all-button" class="text-sm font-medium text-red-600 hover:text-red-500" style="display: none;">
                    Clear All Habits
                </button>
            </div>
        </div>
    </main>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed top-0 left-0 right-0 bottom-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Clear All Habits?</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete all habits? This action cannot be undone.
                </p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3">
                <button id="confirm-delete-button" type="button" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
                    Yes, Clear All
                </button>
                <button id="cancel-delete-button" type="button" class="mt-3 sm:mt-0 inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        // --- App State ---
        let habits = []; // Back to a single array for all habits
        const HABIT_STORAGE_KEY = 'habitScorecardApp.habits'; // The original key

        // --- DOM Elements ---
        const habitForm = document.getElementById('add-habit-form');
        const habitInput = document.getElementById('habit-input');
        const habitTimeInput = document.getElementById('habit-time-input');
        const habitListContainer = document.getElementById('habit-list-container');
        const clearAllButton = document.getElementById('clear-all-button');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');

        // --- Core Functions ---

        /**
         * Helper function to get 24-hour formatted time (HH:MM)
         */
        function getFormattedTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        /**
         * Renders the list of all habits from the global 'habits' array.
         */
        function renderHabits() {
            habitListContainer.innerHTML = ''; // Clear existing list

            if (habits.length === 0) {
                habitListContainer.innerHTML = `<div class="p-6 text-center text-gray-500">No habits logged yet. Add one to get started!</div>`;
                clearAllButton.style.display = 'none'; // Hide clear button
                return;
            }
            
            clearAllButton.style.display = 'inline-block'; // Show clear button

            // Sort by creation date (newest first) before rendering
            habits.sort((a, b) => b.createdAt - a.createdAt);

            habits.forEach(habit => {
                const habitEl = document.createElement('div');
                habitEl.className = 'p-4 flex items-center justify-between space-x-4';
                
                // Format the date and time for display
                const habitDate = new Date(habit.createdAt);
                const displayDate = habitDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                // habit.displayTime already exists as "HH:MM"
                const displayDateTime = `${displayDate} - ${habit.displayTime}`;

                habitEl.innerHTML = `
                    <!-- Habit text and new timestamp -->
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate" title="${habit.text}">${habit.text}</p>
                        <!-- Updated to show full date and time -->
                        <p class="text-sm text-gray-500">${displayDateTime}</p> 
                    </div>
                    
                    <!-- Buttons: Labels + Delete button -->
                    <div class="flex-shrink-0 flex items-center space-x-2">
                        <button data-id="${habit.id}" data-label="positive" class="label-button w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold ${habit.label === 'positive' ? 'label-positive' : 'bg-gray-100 text-gray-700 border-gray-300'}">
                            +
                        </button>
                        <button data-id="${habit.id}" data-label="negative" class="label-button w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold ${habit.label === 'negative' ? 'label-negative' : 'bg-gray-100 text-gray-700 border-gray-300'}">
                            -
                        </button>
                        <button data-id="${habit.id}" data-label="neutral" class="label-button w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold ${habit.label === 'neutral' ? 'label-neutral' : 'bg-gray-100 text-gray-700 border-gray-300'}">
                            =
                        </button>
                        <!-- Delete Button -->
                        <button data-id="${habit.id}" data-action="delete" title="Delete habit" class="ml-2 text-gray-400 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                habitListContainer.appendChild(habitEl);
            });
        }

        /**
         * Saves the current 'habits' array to localStorage.
         */
        function saveHabits() {
            localStorage.setItem(HABIT_STORAGE_KEY, JSON.stringify(habits));
        }

        /**
         * Loads habits from localStorage into the global 'habits' array.
         */
        function loadHabits() {
            const habitsJson = localStorage.getItem(HABIT_STORAGE_KEY);
            // We can now safely parse or default to an empty array.
            habits = JSON.parse(habitsJson) || [];
        }

        /**
         * Adds a new habit to the list.
         */
        function addHabit(e) {
            e.preventDefault();
            const habitText = habitInput.value.trim();
            const habitTime = habitTimeInput.value; // Get time from the input
            
            if (habitText && habitTime) {
                // We use the user-set time to create the "createdAt" timestamp
                const now = new Date(); // Use today as the base date
                const [hours, minutes] = habitTime.split(':');
                const habitDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                
                const newHabit = {
                    id: crypto.randomUUID(), // Create a unique ID
                    text: habitText,
                    label: 'none',
                    createdAt: habitDate.getTime(), // Use user-set time for sorting
                    displayTime: habitTime // The 24-hour string for display
                };
                habits.push(newHabit);
                
                saveHabits();
                renderHabits();
                
                // Reset inputs
                habitInput.value = ''; // Clear input
                habitTimeInput.value = getFormattedTime(new Date()); // Reset time to current
            }
        }

        /**
         * Updates the label of a habit.
         */
        function updateLabel(docId, newLabel) {
            const habit = habits.find(h => h.id === docId);
            if (habit) {
                // Toggle label off if clicked again
                habit.label = habit.label === newLabel ? 'none' : newLabel;
                saveHabits();
                renderHabits();
            }
        }

        /**
         * Deletes a single habit from the list.
         */
        function deleteHabit(docId) {
            habits = habits.filter(h => h.id !== docId);
            saveHabits();
            renderHabits();
        }

        /**
        * Shows the custom confirmation modal.
        */
        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
        }

        /**
         * Hides the custom confirmation modal.
         */
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
        }

        /**
         * Deletes all habits.
         */
        function clearAllHabits() {
            habits = []; // Clear the global array
            saveHabits(); 
            renderHabits(); 
            hideConfirmModal(); 
            console.log("All habits cleared.");
        }

        /**
         * Initializes the application.
         */
        function initialize() {
            // Set time input to current time on load
            habitTimeInput.value = getFormattedTime(new Date());

            loadHabits(); // Load from localStorage
            renderHabits(); // Render to the page

            // --- Event Listeners ---
            habitForm.addEventListener('submit', addHabit);

            // Event listener for label and delete buttons
            habitListContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const { id, label, action } = button.dataset;

                if (label) {
                    updateLabel(id, label);
                    return;
                }
                
                if (action === 'delete') {
                    deleteHabit(id);
                    return;
                }
            });

            clearAllButton.addEventListener('click', showConfirmModal);
            cancelDeleteButton.addEventListener('click', hideConfirmModal);
            confirmDeleteButton.addEventListener('click', clearAllHabits);
        }

        // --- Start the App ---
        initialize();

    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
